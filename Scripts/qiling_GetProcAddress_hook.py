# Credit for this script: https://github.com/N1ght-W0lf/QilingForMalwareAnalysis

from qiling import *
from qiling.const import *

ql = Qiling(['test.dll'], 'qiling/examples/rootfs/x8664_windows')

DLL_MAIN = 0x1800019A0
ql.reg.rcx = 0x180000000	# hinstDLL
ql.reg.rdx = 0x1			# fdwReason
ql.reg.r8 = 0x0				# lpReserved

# FARPROC GetProcAddress(
# 	HMODULE hModule,
# 	LPCSTR  lpProcName
# )
def GetProcAddress_hook(ql, addr, params, retval):
	print("[*] Import: {}".format(params["lpProcName"]))

ql.set_api("GetProcAddress", GetProcAddress_hook, QL_INTERCEPT.EXIT)

ql.verbose = 0
ql.run(begin = DLL_MAIN)